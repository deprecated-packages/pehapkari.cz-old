<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Oficiální stránky PHP komunity">
<meta name="keywords" content="PHP, komunita, programování">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/images/php-square.png">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/assets/bootstrap/bootstrap.min.css?v=1348895509" rel="stylesheet" type="text/css" />

<link href="/assets/prism/prism.css?v=349772678" rel="stylesheet" type="text/css" />
<link href="/assets/prism/prism-custom.css?v=1486744575" rel="stylesheet" type="text/css" />

<link href="/assets/css/style.css?v=1271236425" rel="stylesheet" type="text/css" />

<link href="/favicon.ico" rel="shortcut icon">

<title>Arachne/Security - Separate Authentication and Session Refresh </title>
        <meta property="og:type" content="article" />
<meta property="og:title" content="Arachne/Security - Separate Authentication and Session Refresh" />
<meta property="og:description" content="In many cases Nette/Security lacks the API needed for certain tasks.
Experienced Nette users therefore often recommend using some custom solution instead.
In this article I&#039;ll go over the known problems with user authentication and how Arachne/Security can help you solve them." />
<meta property="og:url" content="https://pehapkari.cz/blog/2017/08/14/arachne-security-separate-authentication-and-session-refresh/" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Arachne/Security - Separate Authentication and Session Refresh" />
<meta name="twitter:description" content="In many cases Nette/Security lacks the API needed for certain tasks.
Experienced Nette users therefore often recommend using some custom solution instead.
In this article I&#039;ll go over the known problems with user authentication and how Arachne/Security can help you solve them." />
    </head>

    <body>
        <header>
        <div class="hidden-sm-down">
        <div class="container-fluid">
            <a href="/"><img src="/assets/images/logo-header.svg?ver" alt="" height="50"></a>

            <nav class="navbar top-navigation">
                <a href="/blog/" class="">
                    <em class="fa fa-newspaper-o fa-fw"></em>
                    Blog
                </a>
                <a href="/vzdelavej-se/" class="">
                    <em class="fa fa-graduation-cap fa-fw"></em>
                    Školení
                </a>
            </nav>
        </div>
    </div>

        <div id="mobile-menu" class="row text-center hidden-md-up">
        <div class="container">
            <a href="/" class="col-4 col-sm-4 ">
                <em class="fa fa-home"></em>
                <br>
                Home
            </a>
            <a href="/blog/" class="col-4 col-sm-4 ">
                <em class="fa fa-book fa-fw"></em>
                <br>
                Blog
            </a>
            <a href="/vzdelavej-se/" class="col-4 col-sm-4 ">
                <em class="fa fa-graduation-cap fa-fw"></em>
                <br>
                Školení
            </a>
        </div>
    </div>
</header>
        <div id="article">
            <div class="container">
                <h1 class="h2 text-center">Arachne/Security - Separate Authentication and Session Refresh</h1>

                <div class="row text-center">
                    <div class="col-md-12">
                        <div class="metadataLine">
    
    <p>
        <em class="fa fa-clock-o fa-fw"></em>
        4 min

        |

        by <strong>Jáchym Toušek</strong>

        &ndash;

        <time datetime="2017-08-Mon">
            14. 8. 2017
        </time>

            </p>
</div>
                    </div>
                </div>

                <br>

                <div id="article-content">
                    <p class="perex">In many cases <a href="https://github.com/nette/security">Nette/Security</a> lacks the API needed for certain tasks.
Experienced Nette users therefore often recommend using some custom solution instead.
In this article I'll go over the known problems with user authentication and how <a href="https://github.com/Arachne/Security">Arachne/Security</a> can help you solve them.</p>

                    <h2 id="separate-authentication"><a href="#separate-authentication">Separate Authentication</a></h2>
<p>For e-shops and many other applications you may need <strong>completely separated accounts for administrators and for custommers</strong>. While it could be solved with authorization instead, separate authentication is often preferred.</p>
<p>Nette/Security does not have a good support for this. Quite often programmers don't use the <code>Nette\Security\User</code> at all and instead work directly with <code>Nette\Http\UserStorage</code>. With Arachne/Security you will use <code>Arachne\Security\Authentication\Firewall</code> instead of <code>Nette\Security\User</code> - however unlike <code>Nette\Security\User</code> it is common to use multiple separate firewalls.</p>
<p>A firewall is basically a shield that protects a part of your application. It is an equivalent of <code>Nette\Security\User</code> with slightly different API:</p>
<ul>
<li><code>Firewall::login(IIdentity $identity)</code> - unlike <code>User::login()</code> you should check the user credentials beforehand and only call this method if the user authenticated successfully.</li>
<li><code>Firewall::logout()</code> - same as <code>User::logout()</code>.</li>
<li><code>Firewall::getIdentity()</code> - use instead of <code>User::isLoggedIn()</code> and <code>User::getIdentity()</code>. Unlike <code>User::getIdentity()</code> it will only return a non-expired <code>IIdentity</code>.</li>
</ul>
<pre><code class="language-yaml">extensions:
    arachne.serviceCollections: Arachne\ServiceCollections\DI\ServiceCollectionsExtension
    arachne.security: Arachne\Security\DI\SecurityExtension

arachne.security:
    firewalls:
        - admin
        - front</code></pre>
<p>The above configuration will create two separate <code>Arachne\Security\Authentication\Firewall</code> services. For autowiring you might want to improve it with your own classes.</p>
<pre><code class="language-yaml">arachne.security:
    firewalls:
        admin: App\Module\AdminModule\Security\AdminFirewall
        front: App\Module\FrontModule\Security\FrontFirewall</code></pre>
<pre><code class="language-php">namespace App\Module\AdminModule\Security;

use Arachne\Security\Authentication\Firewall;

class AdminFirewall extends Firewall
{
    // This class is just for autowiring. You don't need to implement any methods here.
}</code></pre>
<pre><code class="language-php">namespace App\Module\FrontModule\Security;

use Arachne\Security\Authentication\Firewall;

class FrontFirewall extends Firewall
{
    // This class is just for autowiring. You don't need to implement any methods here.
}</code></pre>
<h2 id="session-refresh"><a href="#session-refresh">Session Refresh</a></h2>
<p>In Nette/Security when a user signs in his identity is by default serialized and stored in session and is valid until he signs out again or is signed out automatically because of expiration. The problem is that if you change the privileges of a user or remove his account his session will not be updated with the new privileges or terminated right away. The user will still have the same roles he had when he signed in. Also in case an attacker steals the user's password or cookie the attacker can still use his active session even after the user's password is changed.</p>
<p>In Nette this is considered a feature because to solve it you would have to check the database whether the session is still valid each time he sends a request. I consider this a security issue so I added an optional mechanism to Arachne/Security to deal with this and refresh the session or force-logout the user.</p>
<p>You can enable this mechanism by implementing <code>Arachne\Security\Authentication\IdentityValidatorInterface</code>. <strong>Your implementation gets the user's identity and should return an updated identity or null to force logout.</strong></p>
<p>Here is an example how to register and implement it. It is based on Doctrine and simply creates new <code>Identity</code> every time or forces logout if the user was deleted.</p>
<pre><code class="language-yaml">services:
    admin.identityValidator:
        class: App\Module\AdminModule\Security\AdminIdentityValidator
        tags:
            arachne.security.identityValidator: admin</code></pre>
<pre><code class="language-php">namespace App\Module\AdminModule\Security;

use App\Module\AdminModule\Entity\Role;
use App\Module\AdminModule\Entity\User;
use Arachne\Security\Authentication\IdentityValidatorInterface;
use Doctrine\ORM\EntityManager;
use Doctrine\ORM\EntityRepository;
use Nette\Security\Identity;
use Nette\Security\IIdentity;

class AdminIdentityValidator implements IdentityValidatorInterface
{
    /**
     * @var EntityManager
     */
    private $entityManager;

    public function __construct(EntityManager $entityManager)
    {
        $this-&gt;entityManager = $entityManager;
    }

    public function validateIdentity(IIdentity $identity): ?IIdentity
    {
        $entity = $this-&gt;entityManager-&gt;getRepository(User::class)-&gt;find($identity-&gt;getId());

        if (! $entity) {
             return null;
        }

        $roles = array_map(
            function (Role $role) {
                return $role-&gt;getName();
            },
            $entity-&gt;getRoles()
        );

        return new Identity(
            $entity-&gt;getId(),
            $roles,
            [
                'name' =&gt; $entity-&gt;getName(),
                'email' =&gt; $entity-&gt;getEmail(),
            ]
        );
    }
}</code></pre>
<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>
<p>The goal of Arachne/Security is only to provide a better API then Nette/Security. It just implements what Nette could not because of BC but still internally uses some of the classes and interfaces from Nette/Security.</p>
<p>This article was about authentication improvements. <strong>In the next article I'll talk about how Arachne/Security can help you with authorization.</strong> Later you can also expect an article about annotations-based security using <a href="https://github.com/Arachne/Verifier">Arachne/Verifier</a>.</p>
                </div>
            </div>

            <br>

            <div class="intermezzo">
                <div class="container">
                    
                                            <h2 id="you-might-also-like"><a href="#you-might-also-like">You Might Also Like</a></h2>

                        <ul id="related-posts">
                                                            <li>
                                    <a href="/blog/2017/08/28/arachne-verifier-request-validator-for-nette-application">Arachne/Verifier - Request Validator for Nette/Application &raquo;</a>
                                </li>
                                                            <li>
                                    <a href="/blog/2017/09/04/arachne-entity-loader-object-parameters-for-nette-application">Arachne/EntityLoader - Object Parameters for Nette/Application &raquo;</a>
                                </li>
                                                            <li>
                                    <a href="/blog/2017/08/21/arachne-security-simplified-authorizator-and-fixed-acl-callbacks">Arachne/Security - Simplified Authorizator and Fixed ACL Callbacks &raquo;</a>
                                </li>
                                                            <li>
                                    <a href="/blog/2017/09/11/arachne-verifier-plus-arachne-entity-loader-using-entities-in-verifier-rules">Arachne/Verifier + Arachne/EntityLoader - Using Entities in Verifier Rules &raquo;</a>
                                </li>
                                                    </ul>
                                    </div>
            </div>

            <div class="container">
                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <br>
        </div>

        <script src="/assets/prism/prism.js"></script>
        <script id="dsq-count-scr" src="https://pehapkari.disqus.com/count.js" async defer></script>

        <footer>
    <div class="container-fluid pt-3 pb-3">
        <div class="row">
            <div class="col-md-3 col-6">
                <h3 class="text-light">Pro tebe</h3>

                <ul>
                    <li><a href="/press">Média ke stažení</a></li>
                </ul>
            </div>

            <div class="col-md-3 col-6">
                <h3 class="text-light">Přidej se</h3>
                <ul>
                    <li>
                        <a href="http://bit.ly/pehapkari-newsletter">Newsletter</a>
                        (<a href="http://us8.campaign-archive.com/home/?u=dcf4beafc191796bf6c47321f&id=c4f7564a7b">všechny</a>)
                    </li>
                    <li><a href="https://www.fio.cz/ib2/transparent?a=2301196632">Transparentní účet</a></li>
                    <li><a href="mailto:tomas@pehapkari.cz">Kontakt</a></li>
                </ul>
            </div>

            <div class="col-md-3 col-6">
                <h3 class="text-light">Pracujeme</h3>
                <ul>
                    <li><a href="/vzdelavej-se">Školíme</a></li>
                    <li><a href="https://phpprague.cz">PHP Prague 2018</a></li>
                                                        </ul>
            </div>

            <div class="col-md-3 col-6 text-left">
                <h3 class="text-light mb-4">Sleduj nás na sítích</h3>

                <a href="https://www.meetup.com/friends-of-php-prague/" class="p-3 btn">
                    <em class="fa fa-2x fa-meetup"></em>
                </a>
                <a href="https://www.facebook.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-facebook"></em>
                </a>
                <a href="https://twitter.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-twitter"></em>
                </a>
                <a href="https://github.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-github"></em>
                </a>
                <a href="https://youtube.com/pehapkari/videos" class="p-3 btn">
                    <em class="fa fa-2x fa-youtube-play"></em>
                </a>
                <a href="https://pehapkari.slack.com" class="p-3 btn">
                    <em class="fa fa-2x fa-slack"></em>
                </a>
            </div>
        </div>

        <div class="row text-left pt-3">
            <div class="col-md-7 col-sm-6">
                <p class="powered-by">
                    Tento web jede na <a href="https://statie.org">Statie</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.

                                                                                        
                                            <br>
                        <strong>Našel jsi chybu?</strong> <a href="https://github.com/pehapkari/pehapkari.cz/edit/master/source/_posts/2017/2017-08-14-arachne-security-separate-authentication-and-session-refresh.md">Oprav nám ji</a> prosím
                                    </p>
            </div>
        </div>
    </div>
</footer>

<script src="/assets/prism/prism.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
