<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Oficiální stránky PHP komunity">
<meta name="keywords" content="PHP, komunita, programování">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/images/php-square.png">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/assets/bootstrap/bootstrap.min.css?v=529569196" rel="stylesheet" type="text/css" />

<link href="/assets/prism/prism.css?v=2008713501" rel="stylesheet" type="text/css" />
<link href="/assets/prism/prism-custom.css?v=1794642287" rel="stylesheet" type="text/css" />

<link href="/assets/css/style.css?v=259474598" rel="stylesheet" type="text/css" />

<link href="/favicon.ico" rel="shortcut icon">

<title>Jak snadno a rychle upravovat soubory ve vendoru? </title>
        <meta property="og:type" content="article" />
<meta property="og:title" content="Jak snadno a rychle upravovat soubory ve vendoru?" />
<meta property="og:description" content="Už ses někdy dostal do situace, kdy jsi potřeboval opravit chybu nějaké závislosti ve složce vendor? Jak takovou úpravu sdílet v týmu s ostatními programátory a jak ji udržet v souboru i po spuštění composeru? V tomto článku se dovíš, jak snadno a elegantně se tento problém dá vyřešit během 1 minuty." />
<meta property="og:url" content="https://pehapkari.cz/blog/2017/01/20/jak-snadno-a-rychle-upravovat-soubory-ve-vendoru/" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Jak snadno a rychle upravovat soubory ve vendoru?" />
<meta name="twitter:description" content="Už ses někdy dostal do situace, kdy jsi potřeboval opravit chybu nějaké závislosti ve složce vendor? Jak takovou úpravu sdílet v týmu s ostatními programátory a jak ji udržet v souboru i po spuštění composeru? V tomto článku se dovíš, jak snadno a elegantně se tento problém dá vyřešit během 1 minuty." />
    </head>

    <body>
        <header>
        <div class="hidden-sm-down">
        <div class="container-fluid">
            <a href="/"><img src="/assets/images/logo-header.svg?ver" alt="" height="50"></a>

            <nav class="navbar top-navigation">
                <a href="/blog/" class="">
                    <em class="fa fa-newspaper-o fa-fw"></em>
                    Blog
                </a>
                <a href="/vzdelavej-se/" class="">
                    <em class="fa fa-graduation-cap fa-fw"></em>
                    Školení
                </a>
            </nav>
        </div>
    </div>

        <div id="mobile-menu" class="row text-center hidden-md-up">
        <div class="container">
            <a href="/" class="col-4 col-sm-4 ">
                <em class="fa fa-home"></em>
                <br>
                Home
            </a>
            <a href="/blog/" class="col-4 col-sm-4 ">
                <em class="fa fa-book fa-fw"></em>
                <br>
                Blog
            </a>
            <a href="/vzdelavej-se/" class="col-4 col-sm-4 ">
                <em class="fa fa-graduation-cap fa-fw"></em>
                <br>
                Školení
            </a>
        </div>
    </div>
</header>
        <div id="article">
            <div class="container">
                <h1 class="h2 text-center">Jak snadno a rychle upravovat soubory ve vendoru?</h1>

                <div class="row text-center">
                    <div class="col-md-12">
                        <div class="metadataLine">
    
    <p>
        <em class="fa fa-clock-o fa-fw"></em>
        5 min

        |

        by <strong>Tomáš Pilař</strong>

        &ndash;

        <time datetime="2017-01-Fri">
            20. 1. 2017
        </time>

            </p>
</div>
                    </div>
                </div>

                <br>

                <div id="article-content">
                    <p class="perex">Už ses někdy dostal do situace, kdy jsi potřeboval opravit chybu nějaké závislosti ve složce vendor? Jak takovou úpravu sdílet v týmu s ostatními programátory a jak ji udržet v souboru i po spuštění composeru? V tomto článku se dovíš, jak snadno a elegantně se tento problém dá vyřešit během 1 minuty.</p>

                    <h2 id="chyba-je-ve-vendoru"><a href="#chyba-je-ve-vendoru">Chyba je ve vendoru...</a></h2>
<p>Občas se může stát, že aplikace po spuštění <code>composer update</code> začne vyhazovat notice, warning nebo dokonce fatal error. Co se stalo? Kde je chyba? Je v mojí aplikaci nebo někde jinde... Po pár minutách až hodinách :) zjistíš, že <strong>chyba není v aplikaci, ale v balíčku</strong>, který se ti právě aktualizoval.</p>
<p>Jak je možné, že někdo otaguje balíček, který obsahuje takovou chybu? Každy z nás je pouze člověk a i sebelepší programátor se semtam sekne a vytvoří bug, ať už spravuje svůj osobní nebo celosvětově používaný balíček.</p>
<p>Mně se například po přechodu na PHP7 stalo to, že <a href="https://github.com/doctrine/dbal">Doctrine\DBAL</a> špatně bindoval parametry do dotazů viz. <a href="https://github.com/doctrine/dbal/issues/2261">OCI8 - bindValue overwrite previous values issue</a>. Takže chybu jsme už našli co dál?</p>
<h2 id="jak-chybu-opravit"><a href="#jak-chybu-opravit">Jak chybu opravit?</a></h2>
<h3 id="udelam-vlastni-fork"><a href="#udelam-vlastni-fork">Udělám vlastní fork</a></h3>
<p>Tak to je přeci jednoduché! Pošlu <strong>pull-request s opravou</strong> a počkám až to autor spojí. To ale může trvat dny i měsíce a tag v nedohlednu. Mezitím moje <strong>aplikace nepojede</strong>? Dobře, půjdu na to chytřeji...</p>
<p>Pošlu pull-request a ve své aplikaci nasměruju composer na <strong>svoji forknutou verzi</strong> balíčku a je hotovo. OK, ale než se můj pull-request spojí, tak si musím fork udržovat aktuální...</p>
<h3 id="upravim-si-soubor-lokalne"><a href="#upravim-si-soubor-lokalne">Upravím si soubor lokálně</a></h3>
<p>Co to tedy udělat trochu na prasáčka? Otevřu si soubor ve vendoru a <strong>opravím si to sám</strong> a bude - ehm počkat... Složku vendor si automaticky vytváří a spravuje <a href="https://getcomposer.org/">Composer</a> nepřepíše se mi tedy upravený soubor? Přepíše, ale pouze při vydání nové verze balíčku - bezva! Nové verze balíčku nevychází tak často a až vyjde, tak už to bude třeba opravené.</p>
<p>V tento moment mám vyhráno! Soubor jsem si upravil u sebe - aplikace jede a autorovi balíčku jsem poslal pull-request s opravou. Je čas slavit! Nebo ne?</p>
<h3 id="staci-tohle-reseni"><a href="#staci-tohle-reseni">Stačí tohle řešení?</a></h3>
<p>To záleží na pár otázkách:</p>
<ul>
<li><strong>Pracuji v týmů</strong> a je tedy možné, že stejnou chybu bude mít i kolega?</li>
<li>Nahrávám aplikaci <strong>na server bez vendoru</strong>, který se následně vytvoří přes <code>composer install</code>?</li>
</ul>
<p>Pokud si alespoň na jednu otázku odpovím ano, tak mám opět problém. Společným problémem pro obě otázky je to, že se do vendoru dostane opět ten zabugovaný soubor. Psát kolegům co a kde si mají upravit, aby aplikace fungovala, je velmi nespolehlivé. A jak řešit ten problém na serveru? Oslava se musí odložit... Co s tím?</p>
<h2 id="cweagans-composer-patches"><a href="#cweagans-composer-patches">cweagans/composer-patches</a></h2>
<p>Naštěstí existuje balíček, který za tebe <strong>vyřeší všechny problémy</strong>, na které jsi zde narazil! <a href="https://github.com/cweagans/composer-patches">cweagans/composer-patches</a> je balíček, který obsahuje nástroje pro patchování souborů (co je to <a href="https://cs.wikipedia.org/wiki/Patch">patch</a>?). Zároveň je natolik chytrý, že poslouchá Composer a při instalaci/aktualizaci balíčku dokáže určit, zda pro daný balíček existuje patch a zda ho má aplikovat nebo ho už aplikoval.</p>
<p>Jak je to možné? Composer při instalaci balíčků vyvolává události, na které <code>cweagans/composer-patches</code> poslouchá a podle toho reaguje (jak fungují <a href="https://pehapkari.cz/blog/2016/12/05/symfony-event-dispatcher/">události</a>?).</p>
<p>Dost teorie - jdeme opravit chybu!</p>
<h2 id="oprava-chyby-ve-4-krocich"><a href="#oprava-chyby-ve-4-krocich">Oprava chyby ve 4 krocích</a></h2>
<h3 id="1-nainstalovani-cweagans-composer-patches"><a href="#1-nainstalovani-cweagans-composer-patches">1. Nainstalování cweagans/composer-patches</a></h3>
<p>Nainstalujeme balíček <code>cweagans/composer-patches</code>.</p>
<p><code>composer require cweagans/composer-patches</code></p>
<h3 id="2-vytvoreni-patch-souboru"><a href="#2-vytvoreni-patch-souboru">2. Vytvoření patch souboru</a></h3>
<p>Ve vendor složce si najdeš zabugovaný soubor a zkopíruješ ho do toho samého adresáře pouze s jiným názvem souboru (já používám suffix &quot;-fixed&quot; např. <code>BuggedFile-fixed.php</code>). Následně si zkopírovaný soubor otevřeš a opravíš v něm co potřebuješ. Pak už jen zbývá spustit v CLI příkaz pro vygenerování patch souboru:</p>
<pre><code class="language-bash">diff -u vendor/org/package/src/BuggedFile.php vendor/org/package/src/BuggedFile-fixed.php &gt; patches/bugged-file.patch</code></pre>
<p>Pokud ti CLI napíše, že příkaz <code>diff</code> nebyl nalezen, tak ho bude potřeba doinstalovat viz postupy níže. A pokud ho máš, můžeš <a href="#3-uprava-patch-souboru-pro-cweagans-composer-patches">přeskočit sem</a>.</p>
<h4 id="linux"><a href="#linux">Linux</a></h4>
<p>Je potřeba mít dostupné příkazy <code>diff</code> a <code>patch</code> (dočteš se dál). Oba jsou již v Linuxu dostupné po instalaci, takže na Linuxu jsi v pohodě. :) Pokud je tam náhodou nemáš, tak trochu pogůgli a doinstaluj si je podle své Linuxové distribuce.</p>
<h4 id="windows"><a href="#windows">Windows</a></h4>
<p>Zde budeš potřebovat nainstalovat příkazy <code>diff</code> a <code>patch</code> (dočteš se dál). Pro jejich instalaci si stačí nainstalovat <a href="http://cygwin.org/">Cygwin</a>, který portuje základní příkazy z Linuxu do Windows. Součástí instalace je stažení instalačních souborů pro jednotlivé příkazy, takže v průběhu instalace budeš vyzván k volbě mirroru pro stažení dat.</p>
<ul>
<li>stáhni <a href="http://cygwin.org/setup-x86.exe">http://cygwin.org/setup-x86.exe</a></li>
<li>spusť instalaci a pokračuj příkazem &quot;Next&quot;</li>
<li>zvol libovolný mirror (třeba hned ten první - <a href="http://cygwin.mirror.constant.com">http://cygwin.mirror.constant.com</a>)</li>
<li>v tabulce &quot;Select Packages&quot; vyhledej slovo &quot;patch&quot; (mělo by se ti zobrazit cca 7 rozkliknutelných položek)</li>
<li>vyber &quot;Devel&quot;, &quot;Perl&quot;, &quot;Text&quot; a &quot;Utils&quot; a zaškrtni jednotlivé subpoložky</li>
<li>dokonči instalaci</li>
</ul>
<p>Nyní je třeba zaregistrovat cestu k cygwinu do Path. V proměnném prostředí tedy přidáš do Path cestu k bin složce (&quot;C:\cygwin\bin&quot; - výchozí nastavení).</p>
<h4 id="mac"><a href="#mac">Mac</a></h4>
<p>I zde budeš potřebovat příkazy <code>diff</code> a <code>patch</code> (dočteš se dál). Podle google bys měl mít příkazy již součástí systému, pokud ne, tak trochu pogůgli a doinstaluj si je podle své verze.</p>
<h3 id="3-uprava-patch-souboru-pro-cweagans-composer-patches"><a href="#3-uprava-patch-souboru-pro-cweagans-composer-patches">3. Úprava patch souboru pro cweagans/composer-patches</a></h3>
<p>Otevři si vygenerovaný patch soubor a uprav hlavičku.</p>
<p>Před:</p>
<pre><code class="language-text">--- vendor/org/package/src/BuggedFile.php 2016-12-16 18:50:47.642172308 +0100
+++ vendor/org/package/src/BuggedFile-fixed.php 2017-01-13 11:42:07.000000000 +0100</code></pre>
<p>Po:</p>
<pre><code class="language-text">--- ../src/BuggedFile.php
+++ ../src/BuggedFile.php</code></pre>
<p>Na obou řádcích bude cesta ke stejnému (původnímu) souboru. Někomu také funguje, když místo prvního souboru (za <code>---</code>) dá <code>/dev/null</code>.</p>
<p>Všimni si, že cesta k souborům musí být uvedena <strong>relativně &quot;nad&quot;</strong> složku s balíčkem ve vendoru. Dvě tečky v hlavičce (<code>../</code>) na začátku cest jsou tam tedy právě proto.
Balíček <code>cweagans/composer-patches</code> totiž interně zkouší volat (dozvíme se díky <code>composer -v install</code>) několik různých variant <code>git apply</code> a <code>patch</code> a první zkouší <code>git apply -p1</code>. Právě <code>-p1</code> znamená, že se otrimuje první <code>../</code> a dále se použije cesta relativně k balíčku.
Cesty mohou fungovat i bez <code>../</code>, protože v některém z dalších volání se použije <code>-p0</code>, takže je tam tedy přidávat nemusíte. Nicméně ušetříte si pár zavolání.</p>
<p>Zbytek patche nech tak jak je.</p>
<h3 id="4-nastaveni-cesty-k-patch-souboru-pro-cweagans-composer-patches"><a href="#4-nastaveni-cesty-k-patch-souboru-pro-cweagans-composer-patches">4. Nastavení cesty k patch souboru pro cweagans/composer-patches</a></h3>
<p><code>cweagans/composer-patches</code> se konfiguruje přes soubor <code>composer.json</code>, takže do něj přidáme sekci <code>patches</code>:</p>
<pre><code class="language-json">"extra": {
    "patches": {
        "bugged/package": {
            "Patch message": "patches/bugged-file.patch"
        }
    }
}</code></pre>
<ul>
<li><code>bugged/package</code> je klasický název balíčku např. <code>nette/di</code>, <code>symfony/console</code> apod., na který chceme patch aplikovat</li>
<li><code>Patch message</code> je zpráva, která se vypíše v CLI po aplikování patche.</li>
<li><code>patches/bugged-file.patch</code> je relativní cesta k patch souboru.</li>
</ul>
<p>Toto je základní konfigurace pro lokální patch soubory, ale <code>cweagans/composer-patches</code> podporuje celou řadu dalších možností, které najdeš v <a href="https://github.com/cweagans/composer-patches/blob/master/README.md">readme</a>.</p>
<h3 id="test"><a href="#test">Test</a></h3>
<p>Spustíš příkaz <code>composer install</code> nebo <code>composer update</code> a ve výpisu z composeru uvidíš text:</p>
<pre><code class="language-text"> - Installing bugged/package
    Loading from cache

  - Applying patches for bugged/package
    patches/bugged-file.patch (Patch message)</code></pre>
<p>V tuto chvíli máš upravený soubor ve vendor složce. <code>cweagans/composer-patches</code> ti na pozadí provedl příkaz <code>patch</code>, který aplikuje vygenerovaný patch. Aplikace jede - jak u tebe, tak u kolegů a i na serveru. <strong>Je čas slavit!</strong></p>
<h2 id="shrnuti"><a href="#shrnuti">Shrnutí</a></h2>
<p>V tomto článku jsi našel nástroj, kterým snadno a rychle řešit buggy ve vendoru a zároveň cestu, kterou můžeš opravy sdílet dál (mezi kolegy, na server apod.).</p>
<p>Zde je shrnutí v bodech, jak postupovat:</p>
<ol>
<li><code>composer require cweagans/composer-patches</code></li>
<li>Zkopírovat soubor s buggem a opravit ho</li>
<li>Vytvořit patch soubor (příkaz <code>diff</code>)</li>
<li>Upravit vygenerovaný soubor (opravit hlavičku)</li>
<li>Přidat cestu k patch souboru do composer.json</li>
<li>Spustit <code>composer install</code> nebo <code>composer update</code></li>
<li>Profit!</li>
</ol>
<h2 id="chci-se-dozvedet-vice"><a href="#chci-se-dozvedet-vice">Chci se dozvědět více!</a></h2>
<p>Zde jsou materiály, které ti pomohou pochopit, jak takový nástroj funguje a jak ho můžeš použít.</p>
<ul>
<li><a href="https://github.com/cweagans/composer-patches">https://github.com/cweagans/composer-patches</a></li>
<li><a href="https://getcomposer.org/doc/articles/scripts.md">https://getcomposer.org/doc/articles/scripts.md</a></li>
</ul>
                </div>
            </div>

            <br>

            <div class="intermezzo">
                <div class="container">
                    
                                    </div>
            </div>

            <div class="container">
                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <br>
        </div>

        <script src="/assets/prism/prism.js"></script>
        <script id="dsq-count-scr" src="https://pehapkari.disqus.com/count.js" async defer></script>

        <footer>
    <div class="container-fluid pt-3 pb-3">
        <div class="row">
            <div class="col-md-3 col-6">
                <h3 class="text-light">Pro tebe</h3>

                <ul>
                    <li><a href="/press">Média ke stažení</a></li>
                </ul>
            </div>

            <div class="col-md-3 col-6">
                <h3 class="text-light">Přidej se</h3>
                <ul>
                    <li>
                        <a href="http://bit.ly/pehapkari-newsletter">Newsletter</a>
                        (<a href="http://us8.campaign-archive.com/home/?u=dcf4beafc191796bf6c47321f&id=c4f7564a7b">všechny</a>)
                    </li>
                    <li><a href="https://www.fio.cz/ib2/transparent?a=2301196632">Transparentní účet</a></li>
                    <li><a href="mailto:tomas@pehapkari.cz">Kontakt</a></li>
                </ul>
            </div>

            <div class="col-md-3 col-6">
                <h3 class="text-light">Pracujeme</h3>
                <ul>
                    <li><a href="/vzdelavej-se">Školíme</a></li>
                    <li><a href="https://phpprague.cz">PHP Prague 2018</a></li>
                                                        </ul>
            </div>

            <div class="col-md-3 col-6 text-left">
                <h3 class="text-light mb-4">Sleduj nás na sítích</h3>

                <a href="https://www.meetup.com/friends-of-php-prague/" class="p-3 btn">
                    <em class="fa fa-2x fa-meetup"></em>
                </a>
                <a href="https://www.facebook.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-facebook"></em>
                </a>
                <a href="https://twitter.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-twitter"></em>
                </a>
                <a href="https://github.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-github"></em>
                </a>
                <a href="https://youtube.com/pehapkari/videos" class="p-3 btn">
                    <em class="fa fa-2x fa-youtube-play"></em>
                </a>
                <a href="https://pehapkari.slack.com" class="p-3 btn">
                    <em class="fa fa-2x fa-slack"></em>
                </a>
            </div>
        </div>

        <div class="row text-left pt-3">
            <div class="col-md-7 col-sm-6">
                <p class="powered-by">
                    Tento web jede na <a href="https://statie.org">Statie</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.

                                                                                        
                                            <br>
                        <strong>Našel jsi chybu?</strong> <a href="https://github.com/pehapkari/pehapkari.cz/edit/master/source/_posts/2017/2017-01-20-jak-snadno-a-rychle-upravovat-soubory-ve-vendoru.md">Oprav nám ji</a> prosím
                                    </p>
            </div>
        </div>
    </div>
</footer>

<script src="/assets/prism/prism.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
