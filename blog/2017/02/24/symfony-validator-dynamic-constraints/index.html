<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Oficiální stránky PHP komunity">
<meta name="keywords" content="PHP, komunita, programování">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/images/php-square.png">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/assets/bootstrap/bootstrap.min.css?v=2012085615" rel="stylesheet" type="text/css" />

<link href="/assets/prism/prism.css?v=40137141" rel="stylesheet" type="text/css" />
<link href="/assets/prism/prism-custom.css?v=1185856665" rel="stylesheet" type="text/css" />

<link href="/assets/css/style.css?v=1528806207" rel="stylesheet" type="text/css" />

<link href="/favicon.ico" rel="shortcut icon">

<title>How to use Dynamic Constraints with Symfony/Validator </title>
        <meta property="og:type" content="article" />
<meta property="og:title" content="How to use Dynamic Constraints with Symfony/Validator" />
<meta property="og:description" content="Some edge-cases with Symfony Validator might force you to create a constraint dynamically during the validation. This article will show you how to do it and how to solve error mapping for such constraints." />
<meta property="og:url" content="https://pehapkari.cz/blog/2017/02/24/symfony-validator-dynamic-constraints/" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="How to use Dynamic Constraints with Symfony/Validator" />
<meta name="twitter:description" content="Some edge-cases with Symfony Validator might force you to create a constraint dynamically during the validation. This article will show you how to do it and how to solve error mapping for such constraints." />
    </head>

    <body>
        <header>
        <div class="hidden-sm-down">
        <div class="container-fluid">
            <a href="/"><img src="/assets/images/logo-header.svg?ver" alt="" height="50"></a>

            <nav class="navbar top-navigation">
                <a href="/blog/" class="">
                    <em class="fa fa-newspaper-o fa-fw"></em>
                    Blog
                </a>
                <a href="/vzdelavej-se/" class="">
                    <em class="fa fa-graduation-cap fa-fw"></em>
                    Školení
                </a>
            </nav>
        </div>
    </div>

        <div id="mobile-menu" class="row text-center hidden-md-up">
        <div class="container">
            <a href="/" class="col-4 col-sm-4 ">
                <em class="fa fa-home"></em>
                <br>
                Home
            </a>
            <a href="/blog/" class="col-4 col-sm-4 ">
                <em class="fa fa-book fa-fw"></em>
                <br>
                Blog
            </a>
            <a href="/vzdelavej-se/" class="col-4 col-sm-4 ">
                <em class="fa fa-graduation-cap fa-fw"></em>
                <br>
                Školení
            </a>
        </div>
    </div>
</header>
        <div id="article">
            <div class="container">
                <h1 class="h2 text-center">How to use Dynamic Constraints with Symfony/Validator</h1>

                <div class="row text-center">
                    <div class="col-md-12">
                        <div class="metadataLine">
                    <p class="success">
            <strong><em class="fa fa-fw fa-check-square-o"></em>
                <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/tests/Posts/Year2017/SymfonyValidatorDynamicConstraints">
                    This post is Tested
                </a>
            </strong>
        </p>
    
    <p>
        <em class="fa fa-clock-o fa-fw"></em>
        3 min

        |

        by <strong>Jáchym Toušek</strong>

        &ndash;

        <time datetime="2017-02-Fri">
            24. 2. 2017
        </time>

            </p>
</div>
                    </div>
                </div>

                <br>

                <div id="article-content">
                    <p class="perex">Some edge-cases with Symfony Validator might force you to create a constraint dynamically during the validation. This article will show you how to do it and how to solve error mapping for such constraints.</p>

                    <h3 id="example-use-case"><a href="#example-use-case">Example Use Case</a></h3>
<p>You have an Address entity with a country and a zipcode. There is a <a href="https://github.com/Soullivaneuh/IsoCodesValidator/blob/master/src/Constraints/ZipCode.php">ZipCodeConstraint constraint</a> available but requires you to specify the country in the options. But you cannot do that in an annotation because the country is present in another field of the Address entity.</p>
<pre><code class="language-php">use SLLH\IsoCodesValidator\Constraints\ZipCodeConstraint;
use Symfony\Component\Validator\Constraints as Assert;

class Address
{
    // street, city, etc.

    /**
     * @var string
     * @Assert\NotBlank()
     * @Assert\Country()
     */
    protected $country;

    /**
     * @todo Validate this field based on the country specified in $this-&gt;country.
     * @var string
     * @Assert\NotBlank()
     * @ZipCodeConstraint(country = "???")
     */
    protected $zipcode;

    // getters and setters
}</code></pre>
<h3 id="creating-the-constraint-dynamically"><a href="#creating-the-constraint-dynamically">Creating the constraint dynamically</a></h3>
<p>Well, it's of course impossible to simply fix the code above by replacing the question marks with something. So we need another approach. <strong>The way to go in this case is the Callback constraint.</strong></p>
<pre><code class="language-php">use SLLH\IsoCodesValidator\Constraints\ZipCodeConstraint;
use Symfony\Component\Validator\Constraints as Assert;
use Symfony\Component\Validator\Context\ExecutionContextInterface;

class Address
{
    // same as above

    /**
     * @Assert\Callback()
     */
    public function validateZipcode(ExecutionContextInterface $context)
    {
        $constraint = new ZipCodeConstraint(['country' =&gt; $this-&gt;country]);
        $violations = $context-&gt;getValidator()-&gt;validate($this-&gt;zipcode, $constraint);

        foreach ($violations as $violation) {
            $context-&gt;getViolations()-&gt;add($violation);
        }
    }
}</code></pre>
<h3 id="correct-violation-context"><a href="#correct-violation-context">Correct violation context</a></h3>
<p>Now this is almost correct except for one flaw. If the zipcode is not valid, the violation is not attached to the zipcode field but to the Address class instead. <strong>Fortunately there is a way to solve this problem as well using ContextualValidator.</strong></p>
<pre><code class="language-php">use SLLH\IsoCodesValidator\Constraints\ZipCodeConstraint;
use Symfony\Component\Validator\Constraint;
use Symfony\Component\Validator\Constraints as Assert;
use Symfony\Component\Validator\Context\ExecutionContextInterface;

class Address
{
    // same as above

    /**
     * @Assert\Callback()
     */
    public function validateZipcode(ExecutionContextInterface $context)
    {
        $constraint = new ZipCodeConstraint(['country' =&gt; $this-&gt;country]);
        $context
            -&gt;getValidator()
            -&gt;inContext($context)
            -&gt;atPath('zipcode')
            -&gt;validate($this-&gt;zipcode, $constraint, [Constraint::DEFAULT_GROUP]);
    }
}</code></pre>
<p>And that's it! <strong>The violation will be added to the field directly in the intended context</strong> so there is no need to duplicate it.</p>
<p>This approach should solve most of the advanced use-cases you might have. Along with the tips from my previous articles it makes Symfony/Validator a really powerful validation tool.</p>
<h3 id="usage-with-nette-framework"><a href="#usage-with-nette-framework">Usage with Nette Framework</a></h3>
<p>If you want to use the Symfony/Validator component in your Nette application, you will need <a href="https://github.com/Kdyby/Validator">Kdyby/Validator</a>.</p>
                </div>
            </div>

            <br>

            <div class="intermezzo">
                <div class="container">
                    
                                            <h2 id="you-might-also-like"><a href="#you-might-also-like">You Might Also Like</a></h2>

                        <ul id="related-posts">
                                                            <li>
                                    <a href="/blog/2017/02/11/symfony-validator-comparison-constraints">How to use Comparison Constraints with Symfony/Validator &raquo;</a>
                                </li>
                                                            <li>
                                    <a href="/blog/2017/02/18/symfony-validator-conditional-constraints">How to use Conditional Constraints with Symfony/Validator &raquo;</a>
                                </li>
                                                    </ul>
                                    </div>
            </div>

            <div class="container">
                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <br>
        </div>

        <script src="/assets/prism/prism.js"></script>
        <script id="dsq-count-scr" src="https://pehapkari.disqus.com/count.js" async defer></script>

        <footer>
    <div class="container-fluid pt-3 pb-3">
        <div class="row">
            <div class="col-md-3 col-6">
                <h3 class="text-light">Pro tebe</h3>

                <ul>
                    <li><a href="/press">Média ke stažení</a></li>
                </ul>
            </div>

            <div class="col-md-3 col-6">
                <h3 class="text-light">Přidej se</h3>
                <ul>
                    <li>
                        <a href="http://bit.ly/pehapkari-newsletter">Newsletter</a>
                        (<a href="http://us8.campaign-archive.com/home/?u=dcf4beafc191796bf6c47321f&id=c4f7564a7b">všechny</a>)
                    </li>
                    <li><a href="https://www.fio.cz/ib2/transparent?a=2301196632">Transparentní účet</a></li>
                    <li><a href="mailto:tomas@pehapkari.cz">Kontakt</a></li>
                </ul>
            </div>

            <div class="col-md-3 col-6">
                <h3 class="text-light">Pracujeme</h3>
                <ul>
                    <li><a href="/vzdelavej-se">Školíme</a></li>
                    <li><a href="https://phpprague.cz">PHP Prague 2018</a></li>
                                                        </ul>
            </div>

            <div class="col-md-3 col-6 text-left">
                <h3 class="text-light mb-4">Sleduj nás na sítích</h3>

                <a href="https://www.meetup.com/friends-of-php-prague/" class="p-3 btn">
                    <em class="fa fa-2x fa-meetup"></em>
                </a>
                <a href="https://www.facebook.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-facebook"></em>
                </a>
                <a href="https://twitter.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-twitter"></em>
                </a>
                <a href="https://github.com/pehapkari" class="p-3 btn">
                    <em class="fa fa-2x fa-github"></em>
                </a>
                <a href="https://youtube.com/pehapkari/videos" class="p-3 btn">
                    <em class="fa fa-2x fa-youtube-play"></em>
                </a>
                <a href="https://pehapkari.slack.com" class="p-3 btn">
                    <em class="fa fa-2x fa-slack"></em>
                </a>
            </div>
        </div>

        <div class="row text-left pt-3">
            <div class="col-md-7 col-sm-6">
                <p class="powered-by">
                    Tento web jede na <a href="https://statie.org">Statie</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.

                                                                                        
                                            <br>
                        <strong>Našel jsi chybu?</strong> <a href="https://github.com/pehapkari/pehapkari.cz/edit/master/source/_posts/2017/2017-02-24-symfony-validator-dynamic-constraints.md">Oprav nám ji</a> prosím
                                    </p>
            </div>
        </div>
    </div>
</footer>

<script src="/assets/prism/prism.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
